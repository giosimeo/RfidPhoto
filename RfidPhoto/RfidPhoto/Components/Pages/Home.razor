@page "/"
@using BlazorBootstrap
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Drawing
@using SixLabors.ImageSharp.Drawing.Processing
@using SixLabors.ImageSharp.Processing;
@using SixLabors.ImageSharp.Formats.Jpeg
@using SixLabors.Fonts
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

@* 
<video id="videoFeed" width="390" height="290" />
<canvas class="d-none" id="currentFrame" width="390" height="290" />
<canvas class="d-none" id="currentFrame2" width="390" height="290" />


<button class="btn btn-primary mb-3" @onclick="CaptureFrame">Cattura Immagine 1</button> *@


@code{
    private string frameUri1;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var videoType = "environment";
        await JSRuntime.InvokeVoidAsync("startVideo", "videoFeed", videoType);
    }

    private async Task CaptureFrame()
    {
        try
        {
            Console.WriteLine($"Capture: fatto");
            await JSRuntime.InvokeAsync<String>("getFrame", "videoFeed", "currentFrame", DotNetObjectReference.Create(this));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in CaptureFrame: {ex.Message}");
        }

    }

    [JSInvokable]
    public async Task ProcessImage(string imageString)
    {
        Console.WriteLine($"Process: fatto");
        byte[] imageData = Convert.FromBase64String(imageString.Split(',')[1]);
        using (var image = SixLabors.ImageSharp.Image.Load(imageData))
        {
            image.Mutate(x => x
                .Flip(FlipMode.Horizontal) //To match mirrored webcam image
                .Fill(Color.ParseHex("0008"), new RectangularPolygon(0, 290, 390, 20)) //Set footer bar for caption
            //.DrawText(alignCenter, captionText, captionFont, Color.White, new PointF(8, 230)) //center in footer bar)
            );

            frameUri1 = image.ToBase64String(JpegFormat.Instance);
        }
        Console.WriteLine($"Process: Before insert");

    }
}